<html>
	<head>
		<style type="text/css">
.cell div {width:32px;max-width:32px;height:32px;max-height:32px;}
		</style>
		<script type="text/javascript">

var StandardGenerator = function(depth) {
	this.depth = depth;
};

StandardGenerator.prototype = {
	getHeight: function(x, y) {
		return 1 + this.getRandom(this.depth);
	},
	getRandom: function(n) {
		return Math.floor(Math.random() * n);
	}
};

var HarmonicGenerator = function(w, h, depth, config) {
	this.w = w;
	this.h = h;
	this.depth = depth;
	this.config = config;
	if (config.randomize) {
		this.config.x = {};
		this.config.x.a = [];
		this.config.x.b = [];
		this.config.y = {};
		this.config.y.a = [];
		this.config.y.b = [];
		for (var i = 0; i < config.n; i++) {
			this.config.x.a[i] = Math.random();
			this.config.x.b[i] = Math.random();
			this.config.y.a[i] = Math.random();
			this.config.y.b[i] = Math.random();
		}
	}
};

HarmonicGenerator.prototype = {
	getHeight: function(x, y) {
		var vx = 0.0, vy = 0.0;
		for (var i = 0; i < this.config.n; i++) {
			vx += this.config.x.a[i] * Math.sin(Math.PI * (i + 1) * x / (this.w - 1)) +
				this.config.x.b[i] * Math.cos(Math.PI * (i + 1) * x / (this.w - 1));
			vy += this.config.y.a[i] * Math.sin(Math.PI * (i + 1) * y / (this.h - 1)) +
				this.config.y.b[i] * Math.cos(Math.PI * (i + 1) * y / (this.h - 1));
		}
		vx /= this.config.n;
		vy /= this.config.n;
		return 1 + Math.floor(this.depth * (2.0 + vx + vy) / 4.0);
	}
};

var Pool = function(w, h, d, generator) {
	this.width = w;
	this.height = h;
	this.depth = d;
	this.hasWater = false;
	this.poolHeights = [];
	for (var i = 0; i < this.height; i++) {
		this.poolHeights[i] = [];
		for (var j = 0; j < this.width; j++) {			
			this.poolHeights[i][j] = generator.getHeight(j, i);
		}
	}
	this.waterHeights = [];
	for (var i = 0; i < this.height; i++) {
		this.waterHeights[i] = [];
		for (var j = 0; j < this.width; j++) {
			this.waterHeights[i][j] = -1;
		}
	}
};

Pool.prototype = {
	fill: function() {
		if (this.hasWater) {
			return;
		}
		for (var i = 0; i < this.height; i++) {
			for (var j = 0; j < this.width; j++) {
				if (!this.isBoundary(j, i)) {
					if (!this.findBoundary(j, i, this.poolHeights[i][j])) {
						this.waterHeights[i][j] = this.poolHeights[i][j] + 1;
					}
				}
			}
		}
		this.hasWater = true;
	},
	findBoundary: function(x, y, h) {
		var passed = [];
		for (var i = 0; i < this.height; i++) {
			passed[i] = [];
			for (var j = 0; j < this.width; j++) {
				passed[i][j] = false;
			}
		}
		var stack = new Stack();
		stack.push({_x: x, _y: y});
		while (!stack.isEmpty()) {
			var curr = stack.pop();
			
			if (this.isBoundary(curr._x, curr._y)) {
				return true;
			}
			
			passed[curr._y][curr._x] = true;
			for (var next = this.getNext(curr._x, curr._y), k = 0; k < next.length; k++) {
				if (this.poolHeights[next[k]._y][next[k]._x] <= this.poolHeights[curr._y][curr._x] && !passed[next[k]._y][next[k]._x]) {
					stack.push(next[k]);
				}
			}
		}
		return false;
	},
	getColor: function(x, y) {
		if (this.hasWater && this.waterHeights[y][x] > -1) {
			return "rgb(0,0,255)";
		} else {
			var comp = Math.floor(256.0 / this.depth * this.poolHeights[y][x]);
			return "rgb(" + comp + "," + comp + "," + comp + ")";
		}
	},
	getNext: function(x, y) {
		var next = [];
		if (x > 0)               {next.push({_x: x - 1, _y: y})}
		if (x < this.width - 1)  {next.push({_x: x + 1, _y: y})}
		if (y > 0)               {next.push({_x: x    , _y: y - 1})}
		if (y < this.height - 1) {next.push({_x: x    , _y: y + 1})}
		return next;
	},
	isBoundary: function(x, y) {
		return y == 0 || y == this.height - 1 || x == 0 || x == this.width - 1;
	},
	render: function(el) {
		var table = document.createElement("table");
		table.setAttribute("cellpadding", "0");
		table.setAttribute("cellspacing", "0");
		el.appendChild(table);
		
		for (var i = 0; i < this.height; i++) {
			var tr = document.createElement("tr");
			table.appendChild(tr);
			for (var j = 0; j < this.width; j++) {
				var td = document.createElement("td");
				td.className = "cell";
				var div = document.createElement("div");			
				
				div.style["background-color"] = this.getColor(j, i);
				div.innerHTML = this.poolHeights[i][j];
				
				td.appendChild(div);
				tr.appendChild(td);
			}
		}
	}
};

var Stack = function() {
	this._stack = [];
};

Stack.prototype = {
	isEmpty: function() {
		return this._stack.length == 0;
	},
	push: function(el) {
		this._stack.push(el);
	},
	pop: function() {
		if (this.isEmpty()) {
			return null;
		}
		var result = this._stack[this._stack.length - 1];
		this._stack.length--;
		return result;
	}
};
		</script>
	</head>
	<body>
		<div style="padding:24px;border-width:1px;border-style:dashed;" id="pool"></div>
		<script type="text/javascript">
var pool = new Pool(
	164, 164, 2,
//	new HarmonicGenerator(
//		64, 64, 16, {
//			n: 5,
//			//x: {a: [-1.0, 0.0], b: [0.0, 0.0]},
//			//y: {a: [-1.0, 0.0], b: [0.0, 0.0]}
//			randomize: true
//		}
	//)
	new StandardGenerator(2)
);
pool.fill();
pool.render(document.getElementById('pool'));
		</script>
	</body>
</html>